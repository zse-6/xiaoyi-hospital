<!--pages/mine/mine.wxml-->
<view class="mine-page">
  <!-- ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ -->
  <view class="user-info-section">
    <view class="user-avatar" bindtap="getUserInfo">
      <view class="avatar-placeholder" wx:if="{{!hasUserInfo}}">
        <text class="avatar-icon">ğŸ‘¤</text>
      </view>
      <image class="avatar-image" src="{{userInfo.avatarUrl}}" wx:else></image>
    </view>
    
    <view class="user-details">
      <text class="user-name">{{userInfo.nickName}}</text>
      <text class="user-id">ID: {{userInfo.nickName ? userInfo.nickName.slice(0, 8) : 'ç”¨æˆ·'}}</text>
    </view>
    
    <view class="user-actions">
      <view class="action-btn" bindtap="shareApp">
        <text class="action-icon">ğŸ“¤</text>
        <text>åˆ†äº«</text>
      </view>
      <view class="action-btn" bindtap="checkUpdate" wx:if="{{hasUserInfo}}">
        <text class="action-icon">ğŸ”„</text>
        <text>æ›´æ–°</text>
      </view>
    </view>
  </view>

  <!-- åŠŸèƒ½åˆ—è¡¨ -->
  <view class="functions-section">
    <view class="functions-grid">
      <block wx:for="{{functions}}" wx:key="id">
        <view 
          class="function-item {{selectedFunction === item.name ? 'selected' : ''}}" 
          bindtap="selectFunction"
          data-name="{{item.name}}"
        >
          <view class="function-icon" style="background-color: {{item.color}}">
            <text>{{item.icon}}</text>
            <view class="function-badge" wx:if="{{item.badge > 0}}">
              <text>{{item.badge}}</text>
            </view>
          </view>
          <text class="function-name">{{item.name}}</text>
        </view>
      </block>
    </view>
  </view>

  <!-- ç»Ÿè®¡æ•°æ® -->
  <view class="statistics-section">
    <view 
      class="section-card" 
      bindtap="toggleSection" 
      data-section="statistics"
    >
      <view class="section-header">
        <view class="section-title">
          <text class="section-icon">ğŸ“Š</text>
          <text>å°±è¯Šç»Ÿè®¡</text>
        </view>
        <text class="expand-icon">{{expandedSections.statistics ? 'âˆ’' : '+'}}</text>
      </view>
      
      <view class="section-content" wx:if="{{expandedSections.statistics}}">
        <view class="stats-grid">
          <view class="stat-item">
            <text class="stat-value">{{statistics.totalDiagnosis}}</text>
            <text class="stat-label">æ€»å°±è¯Šæ¬¡æ•°</text>
          </view>
          <view class="stat-item">
            <text class="stat-value">{{statistics.completedProcesses}}</text>
            <text class="stat-label">å®Œæˆæµç¨‹</text>
          </view>
          <view class="stat-item">
            <text class="stat-value">{{statistics.avgAccuracy}}%</text>
            <text class="stat-label">å¹³å‡å‡†ç¡®ç‡</text>
          </view>
          <view class="stat-item">
            <text class="stat-value">{{statistics.emergencyCases}}</text>
            <text class="stat-label">ç´§æ€¥æƒ…å†µ</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- å†å²è®°å½• -->
  <view class="history-section">
    <view 
      class="section-card" 
      bindtap="toggleSection" 
      data-section="history"
    >
      <view class="section-header">
        <view class="section-title">
          <text class="section-icon">ğŸ“–</text>
          <text>å†å²è®°å½•</text>
          <text class="record-count">({{historyRecords.length}})</text>
        </view>
        <view class="section-actions">
          <text class="expand-icon">{{expandedSections.history ? 'âˆ’' : '+'}}</text>
        </view>
      </view>
      
      <view class="section-content" wx:if="{{expandedSections.history}}">
        <view class="history-list">
          <block wx:for="{{historyRecords}}" wx:key="id">
            <view class="history-item" bindtap="viewHistoryDetail" data-id="{{item.id}}">
              <view class="history-header">
                <text class="history-date">{{item.date}}</text>
                <view class="history-status {{item.completed ? 'completed' : 'pending'}}">
                  <text>{{item.completed ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ'}}</text>
                </view>
              </view>
              
              <text class="history-symptoms">{{item.symptoms}}</text>
              
              <view class="history-details">
                <view class="detail-item">
                  <text class="detail-label">æ¨èç§‘å®¤ï¼š</text>
                  <text class="detail-value">{{item.department}}</text>
                </view>
                <view class="detail-item">
                  <text class="detail-label">åŒ¹é…åº¦ï¼š</text>
                  <text class="detail-value">{{item.accuracy}}</text>
                </view>
              </view>
            </view>
          </block>
          
          <view class="history-actions">
            <button class="view-all-btn" bindtap="viewAllHistory" wx:if="{{historyRecords.length > 0}}">
              <text>æŸ¥çœ‹å…¨éƒ¨å†å²</text>
            </button>
            <button class="clear-btn" bindtap="clearHistory" wx:if="{{historyRecords.length > 0}}">
              <text>æ¸…é™¤å†å²è®°å½•</text>
            </button>
            <view class="empty-history" wx:else>
              <text class="empty-icon">ğŸ“</text>
              <text class="empty-text">æš‚æ— å†å²è®°å½•</text>
              <text class="empty-tip">å¼€å§‹ä½¿ç”¨æ™ºèƒ½åˆ†è¯ŠåŠŸèƒ½å§</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- å¥åº·æ¡£æ¡ˆ -->
  <view class="profile-section">
    <view 
      class="section-card" 
      bindtap="toggleSection" 
      data-section="profile"
    >
      <view class="section-header">
        <view class="section-title">
          <text class="section-icon">ğŸ“‹</text>
          <text>å¥åº·æ¡£æ¡ˆ</text>
        </view>
        <view class="section-actions">
          <text class="expand-icon">{{expandedSections.profile ? 'âˆ’' : '+'}}</text>
          <view class="edit-btn" bindtap="editProfile" wx:if="{{!editingProfile}}">
            <text>ç¼–è¾‘</text>
          </view>
          <view class="save-btn" bindtap="saveProfile" wx:if="{{editingProfile}}">
            <text>ä¿å­˜</text>
          </view>
        </view>
      </view>
      
      <view class="section-content" wx:if="{{expandedSections.profile}}">
        <view class="profile-form">
          <!-- è¡€å‹ -->
          <view class="form-item">
            <text class="form-label">è¡€å‹</text>
            <picker 
              class="form-input" 
              range="{{['Aå‹', 'Bå‹', 'Oå‹', 'ABå‹', 'å…¶ä»–']}}"
              value="{{['Aå‹', 'Bå‹', 'Oå‹', 'ABå‹', 'å…¶ä»–'].indexOf(healthProfile.bloodType)}}"
              bindchange="updateProfileField"
              data-field="bloodType"
              disabled="{{!editingProfile}}"
            >
              <text>{{healthProfile.bloodType}}</text>
            </picker>
          </view>
          
          <!-- è¿‡æ•å² -->
          <view class="form-item">
            <text class="form-label">è¿‡æ•å²</text>
            <view class="allergy-list">
              <block wx:for="{{healthProfile.allergies}}" wx:key="*this">
                <view class="allergy-tag">
                  <text>{{item}}</text>
                  <view 
                    class="remove-btn" 
                    bindtap="removeAllergy"
                    data-index="{{index}}"
                    wx:if="{{editingProfile}}"
                  >
                    <text>Ã—</text>
                  </view>
                </view>
              </block>
              <view 
                class="add-btn" 
                bindtap="addAllergy"
                wx:if="{{editingProfile}}"
              >
                <text>+ æ·»åŠ </text>
              </view>
            </view>
          </view>
          
          <!-- æ…¢æ€§ç—…å² -->
          <view class="form-item">
            <text class="form-label">æ…¢æ€§ç—…å²</text>
            <view class="disease-list">
              <block wx:for="{{healthProfile.chronicDiseases}}" wx:key="*this">
                <view class="disease-tag">
                  <text>{{item}}</text>
                </view>
              </block>
              <view 
                class="add-btn" 
                bindtap="addChronicDisease"
                wx:if="{{editingProfile}}"
              >
                <text>+ æ·»åŠ </text>
              </view>
            </view>
          </view>
          
          <!-- å¸¸ç”¨è¯ç‰© -->
          <view class="form-item">
            <text class="form-label">å¸¸ç”¨è¯ç‰©</text>
            <view class="medication-list">
              <block wx:for="{{healthProfile.medications}}" wx:key="*this">
                <view class="medication-tag">
                  <text>{{item}}</text>
                </view>
              </block>
              <view 
                class="add-btn" 
                bindtap="addMedication"
                wx:if="{{editingProfile}}"
              >
                <text>+ æ·»åŠ </text>
              </view>
            </view>
          </view>
          
          <!-- å¯¼å‡ºæŒ‰é’® -->
          <button class="export-btn" bindtap="exportHealthProfile" wx:if="{{!editingProfile}}">
            <text>ğŸ“¥ å¯¼å‡ºå¥åº·æ¡£æ¡ˆ</text>
          </button>
        </view>
      </view>
    </view>
  </view>

  <!-- æ”¶è—åŒ»é™¢ -->
  <view class="favorites-section">
    <view 
      class="section-card" 
      bindtap="toggleSection" 
      data-section="favorites"
    >
      <view class="section-header">
        <view class="section-title">
          <text class="section-icon">ğŸ¥</text>
          <text>æ”¶è—åŒ»é™¢</text>
        </view>
        <text class="expand-icon">{{expandedSections.favorites ? 'âˆ’' : '+'}}</text>
      </view>
      
      <view class="section-content" wx:if="{{expandedSections.favorites}}">
        <view class="favorites-list">
          <block wx:for="{{favoriteHospitals}}" wx:key="id">
            <view class="hospital-card">
              <view class="hospital-header">
                <text class="hospital-name">{{item.name}}</text>
                <view class="hospital-actions">
                  <view 
                    class="hospital-action" 
                    bindtap="toggleFavoriteHospital"
                    data-id="{{item.id}}"
                    catchtap
                  >
                    <text>â­</text>
                  </view>
                </view>
              </view>
              
              <view class="hospital-info">
                <text class="info-item">ğŸ·ï¸ {{item.level}}</text>
                <text class="info-item">ğŸ“ {{item.department}}</text>
                <text class="info-item">ğŸ“… {{item.lastVisit}}</text>
              </view>
              
              <view class="hospital-buttons">
                <button 
                  class="action-btn" 
                  bindtap="viewHospitalDetail"
                  data-id="{{item.id}}"
                >
                  <text>æŸ¥çœ‹è¯¦æƒ…</text>
                </button>
                <button class="action-btn primary" bindtap="viewAllHistory">
                  <text>å¯¼èˆªå‰å¾€</text>
                </button>
              </view>
            </view>
          </block>
          
          <view class="empty-favorites" wx:if="{{favoriteHospitals.length === 0}}">
            <text class="empty-icon">ğŸ¥</text>
            <text class="empty-text">æš‚æ— æ”¶è—åŒ»é™¢</text>
            <text class="empty-tip">åœ¨åˆ†è¯Šç»“æœé¡µé¢å¯ä»¥æ”¶è—åŒ»é™¢å“¦</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- è®¾ç½® -->
  <view class="settings-section">
    <view 
      class="section-card" 
      bindtap="toggleSection" 
      data-section="settings"
    >
      <view class="section-header">
        <view class="section-title">
          <text class="section-icon">âš™ï¸</text>
          <text>è®¾ç½®</text>
        </view>
        <text class="expand-icon">{{expandedSections.settings ? 'âˆ’' : '+'}}</text>
      </view>
      
      <view class="section-content" wx:if="{{expandedSections.settings}}">
        <view class="settings-list">
          <block wx:for="{{settings}}" wx:key="id">
            <view class="setting-item">
              <text class="setting-name">{{item.name}}</text>
              <switch 
                checked="{{item.enabled}}" 
                bindchange="toggleSetting"
                data-id="{{item.id}}"
                color="#2a8ce5"
              />
            </view>
          </block>
          
          <view class="setting-actions">
            <button class="action-btn" bindtap="viewPrivacyPolicy">
              <text>éšç§æ”¿ç­–</text>
            </button>
            <button class="action-btn" bindtap="viewAboutUs">
              <text>å…³äºæˆ‘ä»¬</text>
            </button>
            <button class="action-btn" bindtap="giveFeedback">
              <text>åé¦ˆå»ºè®®</text>
            </button>
            <button class="action-btn logout" bindtap="logout" wx:if="{{hasUserInfo}}">
              <text>é€€å‡ºç™»å½•</text>
            </button>
          </view>
          
          <view class="app-info">
            <text class="info-item">ç‰ˆæœ¬å·ï¼š{{appInfo.version}}</text>
            <text class="info-item">æœ€åæ›´æ–°ï¼š{{appInfo.lastUpdate}}</text>
            <text class="info-item">åº”ç”¨å¤§å°ï¼š{{appInfo.size}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>